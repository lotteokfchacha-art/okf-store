<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OKF Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body {
            font-family: "Pretendard Variable", "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-white text-gray-900 antialiased pb-24">

    <!-- Config -->
    <script>
        // --- CONFIGURATION ---
        // 1. Deploy code.gs as Web App (Execute as Me, Who has access: Anyone)
        // 2. Paste the Web App URL below
        const GAS_APP_URL = 'https://script.google.com/macros/s/AKfycbx79wMHxEeF80sOXeVKhnIGZOAK-nlcId4nHJkeftvpf3Sk_viqtt7GvErU_HdO_Rr1/exec';

        // If true, uses hardcoded data for testing without GAS
        const MOCK_MODE = false; 
    </script>

    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 bg-white/90 backdrop-blur-md z-40 border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="font-bold text-xl tracking-tight text-green-700 flex items-center gap-2">
                <span>OKF Store</span>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="toggleLang()"
                    class="text-sm font-medium text-gray-500 hover:text-gray-900 transition px-2 py-1 rounded-md hover:bg-gray-100"
                    id="lang-btn">RU</button>
                <button onclick="openCart()"
                    class="flex items-center gap-2 cursor-pointer px-4 py-2 hover:bg-gray-100 rounded-full transition relative group">
                    <div class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="h-6 w-6 text-gray-700 group-hover:text-black transition" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                        </svg>
                        <span id="cart-badge"
                            class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center hidden shadow-sm border border-white">0</span>
                    </div>
                    <span class="font-medium text-gray-700 group-hover:text-black hidden md:block"
                        data-t="cart_title">Корзина</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto pt-20 px-4 md:px-8">

        <!-- Hero Section -->
        <div class="mb-10 py-6 border-b border-gray-50">
            <h1 class="text-2xl md:text-4xl font-bold text-gray-900 mb-3" data-t="hero_title">OKF Store — Официальная
                витрина дистрибьютора в Узбекистане</h1>
            <p class="text-gray-600 text-sm md:text-lg max-w-3xl leading-relaxed" data-t="hero_subtitle">Оптовые и
                розничные поставки качественных товаров. Выберите интересующие позиции и оставьте заявку на персональное
                предложение.</p>
        </div>

        <!-- Search & Filter -->
        <div
            class="sticky top-16 bg-white z-30 py-4 -mx-4 px-4 md:mx-0 md:px-0 border-b md:border-none border-gray-50 mb-6 flex flex-col md:flex-row md:items-center gap-4">
            <div class="relative w-full md:max-w-sm">
                <input type="text" id="search-input" placeholder="Поиск..."
                    class="w-full bg-gray-100 border-none rounded-xl py-3 pl-10 pr-4 text-sm focus:ring-2 focus:ring-green-500 outline-none placeholder-gray-400 transition hover:bg-gray-50">
                <svg class="absolute left-3 top-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>

            <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1 md:pb-0 md:flex-wrap" id="category-chips">
                <!-- Chips injected by JS -->
            </div>
        </div>

        <!-- Product Grid -->
        <div id="product-grid"
            class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6 pb-24">
            <!-- Products injected by JS -->
            <div class="col-span-2 text-center py-10 text-gray-400 text-sm animate-pulse">Загрузка...</div>
        </div>

        <!-- Payment & Delivery Info -->
        <div class="mt-8 mb-12 bg-gray-50 rounded-2xl p-6 md:p-8 border border-gray-100">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2" data-t="delivery_title">Оплата и Доставка</h2>
            <div class="prose prose-sm text-gray-600 max-w-none leading-relaxed whitespace-pre-line"
                data-t="delivery_text">
                Для вашего удобства мы работаем по системе подтвержденных заказов:

                Вы выбираете товар на сайте. Оформление заявок осуществляется на сумму от 300 000 UZS.

                Наш менеджер связывается с вами для уточнения деталей, проверки наличия и согласования времени доставки
                в пределах города Ташкента.

                Оплата производится после подтверждения наличия товара на складе. Мы работаем по системе персонального
                обслуживания: менеджер проверяет резерв и связывается с вами для выбора удобного способа оплаты
                (терминал, перечисление или наличные).
            </div>
        </div>
    </main>

    <!-- Footer Legal -->
    <footer class="max-w-7xl mx-auto px-4 md:px-8 pb-10 text-center md:text-left">
        <p class="text-[10px] text-gray-400 leading-normal max-w-4xl" data-t="footer_legal">
            Информация на сайте okf-store.uz не является публичной офертой. Сайт выполняет функцию электронного каталога
            для ознакомления с ассортиментом компании. Все торговые операции финализируются вне данного ресурса в
            соответствии с законодательством РУз.
        </p>
    </footer>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeCart()"></div>
        <!-- Mobile: Bottom Sheet, Desktop: Right Sidebar or Centered Modal. Let's do Centered Modal for PC style -->
        <div class="absolute bottom-0 md:top-1/2 md:left-1/2 md:bottom-auto md:-translate-x-1/2 md:-translate-y-1/2 left-0 right-0 bg-white md:rounded-2xl rounded-t-3xl p-6 min-h-[50vh] md:min-h-0 md:h-auto md:max-h-[85vh] md:w-full md:max-w-lg overflow-y-auto transform transition-transform duration-300 translate-y-full md:translate-y-10 md:opacity-0 shadow-2xl"
            id="cart-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold" data-t="cart_title">Корзина</h2>
                <button onclick="closeCart()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-full transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div id="cart-items" class="space-y-4 mb-24 md:mb-6">
                <div class="text-center text-gray-400 py-10" data-t="cart_empty">Корзина пуста</div>
            </div>

            <!-- Cart Footer -->
            <div
                class="fixed bottom-0 md:static left-0 right-0 p-6 md:p-0 bg-white border-t border-gray-100 md:border-none">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-500" data-t="total">Итого:</span>
                    <span class="text-xl font-bold" id="cart-total">0 UZS</span>
                </div>
                <button onclick="openCheckout()" id="checkout-btn"
                    class="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-green-200 active:scale-95 transition disabled:opacity-50 disabled:cursor-not-allowed hover:bg-green-700"
                    disabled data-t="checkout_btn">
                    Оформить заказ
                </button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 z-[60] hidden bg-white">
        <div class="max-w-md mx-auto h-full flex flex-col">
            <div class="flex items-center p-4 border-b border-gray-100">
                <button onclick="closeCheckout()" class="p-2 mr-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>
                </button>
                <h2 class="text-lg font-bold" data-t="checkout_title">Оформление заказа</h2>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-6">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-t="label_name">Имя</label>
                    <input type="text" id="order-name"
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-green-500 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-t="label_phone">Телефон</label>
                    <input type="tel" id="order-phone" placeholder="+998"
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-green-500 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-t="label_district">Район
                        (Ташкент)</label>
                    <select id="order-district"
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-green-500 outline-none appearance-none">
                        <option value="" disabled selected>Выберите район</option>
                        <option value="Алмазарский">Алмазарский</option>
                        <option value="Бектемирский">Бектемирский</option>
                        <option value="Мирабадский">Мирабадский</option>
                        <option value="Мирзо-Улугбекский">Мирзо-Улугбекский</option>
                        <option value="Сергелийский">Сергелийский</option>
                        <option value="Учтепинский">Учтепинский</option>
                        <option value="Чиланзарский">Чиланзарский</option>
                        <option value="Шайхантахурский">Шайхантахурский</option>
                        <option value="Юнусабадский">Юнусабадский</option>
                        <option value="Яккасарайский">Яккасарайский</option>
                        <option value="Яшнабадский">Яшнабадский</option>
                        <option value="Янгихаётский">Янгихаётский</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-t="label_address">Точный адрес
                        (Улица, Дом, Кв)</label>
                    <textarea id="order-address" rows="3"
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-green-500 outline-none"></textarea>
                </div>

            </div>

            <div class="p-6 border-t border-gray-100">
                <button onclick="submitOrder()" id="submit-btn"
                    class="w-full bg-black text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition"
                    data-t="submit_btn">
                    Подтвердить заказ
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="toast"
        class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-xl z-[70] transition-opacity opacity-0 pointer-events-none text-sm font-medium">
        Notification
    </div>

    <!-- Lightbox -->
    <div id="lightbox"
        class="fixed inset-0 z-[80] bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm"
        onclick="closeImage()">
        <button onclick="closeImage()"
            class="absolute top-4 right-4 text-white p-2 bg-white/10 rounded-full hover:bg-white/20 transition">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        <img id="lightbox-img" src="" class="max-h-full max-w-full object-contain rounded-lg shadow-2xl"
            onclick="event.stopPropagation()">
    </div>

    <script>
        // --- DATA & STATE ---
        const TR = {
            ru: {
                search: 'Поиск...',
                add: 'Добавить к заявке',
                cart_title: 'Корзина',
                cart_empty: 'В корзине пусто',
                total: 'Итого:',
                checkout_btn: 'Оформить заявку',
                checkout_title: 'Оформление',
                label_name: 'Имя',
                label_phone: 'Телефон',
                label_district: 'Район',
                label_address: 'Адрес',
                submit_btn: 'Подтвердить заявку',
                all: 'Все',
                success: 'Заявка успешно отправлена!',
                error: 'Ошибка отправки.',
                added: 'Добавлено в заявку: ',
                min_order_error: 'Минимальная сумма заказа 300 000 сум',
                hero_title: 'OKF Store — Официальная витрина дистрибьютора в Узбекистане',
                hero_subtitle: 'Оптовые и розничные поставки качественных товаров. Выберите интересующие позиции и оставьте заявку на персональное предложение.',
                delivery_title: 'Оплата и Доставка',
                delivery_text: 'Для вашего удобства мы работаем по системе подтвержденных заказов:\n\nВы выбираете товар на сайте. Оформление заявок осуществляется на сумму от 300 000 UZS.\n\nНаш менеджер связывается с вами для уточнения деталей, проверки наличия и согласования времени доставки в пределах города Ташкента.\n\nОплата производится после подтверждения наличия товара на складе. Мы работаем по системе персонального обслуживания: менеджер проверяет резерв и связывается с вами для выбора удобного способа оплаты (терминал, перечисление или наличные).',
                footer_legal: 'Информация на сайте okf-store.uz не является публичной офертой. Сайт выполняет функцию электронного каталога для ознакомления с ассортиментом компании. Все торговые операции финализируются вне данного ресурса в соответствии с законодательством РУз.'
            },
            en: {
                search: 'Search...',
                add: 'Add to Request',
                cart_title: 'Request List',
                cart_empty: 'List is empty',
                total: 'Total:',
                checkout_btn: 'Proceed to Request',
                checkout_title: 'Request Info',
                label_name: 'Name',
                label_phone: 'Phone',
                label_district: 'District',
                label_address: 'Address',
                submit_btn: 'Confirm Request',
                all: 'All',
                success: 'Request sent successfully!',
                error: 'Error sending request.',
                added: 'Added to request: ',
                min_order_error: 'Minimum order amount is 300,000 UZS',
                hero_title: 'OKF Store — Official Distributor Showcase in Uzbekistan',
                hero_subtitle: 'Wholesale and retail supplies of quality products. Select items and submit a request for a personal offer.',
                delivery_title: 'Payment & Delivery',
                delivery_text: 'We work on a confirmed order basis for your convenience.\n\nYou select items on the site.\nOur manager contacts you to clarify details and availability.\n\nPayment is made after confirmation of stock availability. We work on a personal service basis: a manager checks the reserve and contacts you to choose a convenient payment method (terminal, bank transfer, or cash).',
                footer_legal: 'Information on okf-store.uz is not a public offer. The site serves as an electronic catalog for product familiarization. All trading operations are finalized outside this resource in accordance with the legislation of the Republic of Uzbekistan.'
            },
            uz: {
                search: 'Qidirish...',
                add: 'So\'rovga qo\'shish',
                cart_title: 'So\'rov ro\'yxati',
                cart_empty: 'Ro\'yxat bo\'sh',
                total: 'Jami:',
                checkout_btn: 'Rasmiylashtirish',
                checkout_title: 'Ma\'lumotlar',
                label_name: 'Ism',
                label_phone: 'Telefon',
                label_district: 'Tuman',
                label_address: 'Manzil',
                submit_btn: 'Tasdiqlash',
                all: 'Hammasi',
                success: 'So\'rov muvaffaqiyatli yuborildi!',
                error: 'Xatolik yuz berdi.',
                added: 'Qo\'shildi: ',
                min_order_error: 'Minimal buyurtma narxi 300 000 so\'m',
                hero_title: 'OKF Store — O\'zbekistondagi rasmiy distribyutor vitrinasi',
                hero_subtitle: 'Sifatli mahsulotlarning ulgurji va chakana ta\'minoti. Kerakli mahsulotlarni tanlang va shaxsiy taklif olish uchun so\'rov qoldiring.',
                delivery_title: 'To\'lov va yetkazib berish',
                delivery_text: 'Sizga qulay bo\'lishi uchun biz tasdiqlangan buyurtmalar tizimi asosida ishlaymiz.\n\nSiz saytda mahsulot tanlaysiz.\nMenejerimiz tafsilotlar va mavjudligini aniqlashtirish uchun siz bilan bog\'lanadi.\n\nTo\'lov omborda tovar mavjudligi tasdiqlangandan keyin amalga oshiriladi. Biz shaxsiy xizmat ko\'rsatish tizimi bo\'yicha ishlaymiz: menejer zaxirani tekshiradi va qulay to\'lov usulini (terminal, o\'tkazma yoki naqd pul) tanlash uchun siz bilan bog\'lanadi.',
                footer_legal: 'okf-store.uz saytidagi ma\'lumotlar ommaviy oferta hisoblanmaydi. Sayt kompaniya assortimenti bilan tanishish uchun elektron katalog vazifasini bajaradi. Barcha savdo operatsiyalari O\'zbekiston Respublikasi qonunchiligiga muvofiq ushbu resursdan tashqarida yakunlanadi.'
            }
        };

        const CATEGORY_TR = {
            en: {
                'Напитки': 'Drinks',
                'Сгущенка': 'Condensed Milk',
                'Вафли': 'Wafers',
                'Печенье': 'Cookies',
                'Другое': 'Other',
                // Add more as needed
            },
            uz: {
                'Напитки': 'Ichimliklar',
                'Сгущенка': 'Quyultirilgan sut',
                'Вафли': 'Vafli',
                'Печенье': 'Pechenye',
                'Другое': 'Boshqa'
            }
        };

        const MOCK_PRODUCTS = [
            { name: 'OKF Aloe Vera Original', price: 12000, category: 'Drinks', image: 'https://m.media-amazon.com/images/I/71u-sE+bZ+L._SL1500_.jpg' },
            { name: 'OKF Aloe Vera King', price: 15000, category: 'Drinks', image: 'https://m.media-amazon.com/images/I/41DqWspB-JL.jpg' },
            { name: 'OKF Coffee Drink', price: 18000, category: 'Coffee', image: 'https://m.media-amazon.com/images/I/71R1k-wQy1L.jpg' },
            { name: 'Milkis Original', price: 11000, category: 'Soda', image: 'https://m.media-amazon.com/images/I/61kP7J+VqLL.jpg' },
            { name: 'Choco Pie', price: 25000, category: 'Snacks', image: 'https://m.media-amazon.com/images/I/61F+d+a+VLL.jpg' },
        ];

        const log = (msg) => {
            console.log(msg);
            const el = document.getElementById('debug-log');
            if (el) el.innerText += '\n' + (typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg);
        }

        let state = {
            lang: 'ru',
            products: [],
            cart: [],
            activeCategory: 'all',
            searchQuery: ''
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadCart();
            fetchProducts();
            renderLang();
        });

        // --- LOGIC ---
        function toggleLang() {
            const langs = ['ru', 'en', 'uz'];
            let idx = langs.indexOf(state.lang);
            state.lang = langs[(idx + 1) % 3];
            document.getElementById('lang-btn').innerText = state.lang.toUpperCase();
            renderLang();
            renderCategories(); // Update "All" text
            renderProducts(); // Re-render to update buttons if needed
        }

        // --- SECURITY ---
        function escapeHtml(text) {
            if (typeof text !== 'string' && typeof text !== 'number') return "";
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderLang() {
            const t = TR[state.lang];
            document.querySelectorAll('[data-t]').forEach(el => {
                const key = el.getAttribute('data-t');
                if (t[key]) el.innerText = t[key];
            });
            document.getElementById('search-input').placeholder = t.search;
        }

        async function fetchProducts() {
            log("Starting fetch...");
            log("URL: " + GAS_APP_URL);

            if (MOCK_MODE) {
                state.products = MOCK_PRODUCTS.map((p, i) => ({ ...p, id: i }));
            } else {
                try {
                    const res = await fetch(GAS_APP_URL);
                    log("Response status: " + res.status);

                    if (!res.ok) throw new Error("HTTP " + res.status);

                    const text = await res.text();
                    log("Raw body length: " + text.length);
                    log("Raw body start: " + text.substring(0, 100)); // Log first 100 chars

                    try {
                        state.products = JSON.parse(text);
                        log("Parsed JSON items: " + state.products.length);
                        if (state.products.length > 0) {
                            log("First Item: " + JSON.stringify(state.products[0]));
                        }
                    } catch (parseErr) {
                        log("JSON Parse Error: " + parseErr);
                        log("Trying to handle as HTML error...");
                        if (text.includes("Google Drive")) log("It looks like a Google Drive error page, not JSON.");
                        if (text.includes("script.google.com")) log("It looks like a script error page.");
                    }

                } catch (e) {
                    console.error("Fetch error", e);
                    log("FETCH ERROR: " + e.toString());
                    showToast('Failed to load products');
                }
            }
            renderCategories();
            renderProducts();
        }

        function getTranslatedCategory(cat) {
            if (state.lang === 'ru') return cat;
            return CATEGORY_TR[state.lang]?.[cat] || cat;
        }

        function renderCategories() {
            const container = document.getElementById('category-chips');
            // Unique categories
            const categories = ['all', ...new Set(state.products.map(p => p.category || 'Other'))];

            container.innerHTML = categories.map(cat => `
                <button onclick="setCategory('${cat === 'all' ? 'all' : escapeHtml(cat)}')" 
                    class="px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition ${state.activeCategory === cat ? 'bg-black text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                    ${cat === 'all' ? TR[state.lang].all : escapeHtml(getTranslatedCategory(cat))}
                </button>
            `).join('');
        }

        function setCategory(cat) {
            state.activeCategory = cat;
            renderCategories();
            renderProducts();
        }

        document.getElementById('search-input').addEventListener('input', (e) => {
            state.searchQuery = e.target.value.toLowerCase();
            renderProducts();
        });

        function renderProducts() {
            const grid = document.getElementById('product-grid');
            const filtered = state.products.filter(p => {
                const matchSearch = p.name.toLowerCase().includes(state.searchQuery);
                const matchCat = state.activeCategory === 'all' || p.category === state.activeCategory;
                return matchSearch && matchCat;
            });

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-2 text-center text-gray-400 py-10">Ничего не найдено</div>`;
                return;
            }

            grid.innerHTML = filtered.map((p) => {
                // Find by ID for robustness
                const inCart = state.cart.find(c => c.id === p.id);
                const count = inCart ? inCart.count : 0;

                return `
                <div class="bg-white rounded-2xl p-4 shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-gray-50 flex flex-col items-center text-center group active:scale-[0.98] transition">
                    <div class="w-full h-32 mb-4 flex items-center justify-center overflow-hidden rounded-xl bg-gray-50 relative cursor-zoom-in" onclick="openImage('${p.image || ''}')">
                         <!-- Fallback image logic if needed -->
                        <img src="${p.image || 'https://via.placeholder.com/150'}" class="h-full object-contain mix-blend-multiply group-hover:scale-110 transition duration-500" alt="${escapeHtml(p.name)}">
                    </div>
                    <h3 class="font-medium text-xs md:text-sm text-gray-800 mb-2 leading-snug w-full text-center">${escapeHtml(p.name)}</h3>
                    ${p.country ? `<div class="text-[10px] text-gray-500 mb-2 uppercase tracking-wide border border-gray-200 rounded-md px-1 inline-block">${escapeHtml(p.country)}</div>` : ''}
                    <div class="mt-auto pt-3 w-full">
                        <div class="text-green-700 font-bold mb-3">${Number(p.price).toLocaleString()} UZS</div>
                        
                        ${count > 0 ? `
                            <div class="flex items-center justify-between bg-gray-900 text-white rounded-xl overflow-hidden h-[42px]">
                                <button onclick="updateProductCount(${p.id}, -1)" class="w-12 h-full flex items-center justify-center hover:bg-gray-700 transition font-bold text-lg">-</button>
                                <span class="font-bold text-sm">${count}</span>
                                <button onclick="updateProductCount(${p.id}, 1)" class="w-12 h-full flex items-center justify-center hover:bg-gray-700 transition font-bold text-lg">+</button>
                            </div>
                        ` : `
                            <button onclick="updateProductCount(${p.id}, 1)" class="w-full bg-gray-900 text-white text-xs font-bold py-3 rounded-xl hover:bg-green-600 transition h-[42px]">${TR[state.lang].add}</button>
                        `}
                    </div>
                </div>
            `}).join('');
        }

        // --- CART ---


        function loadCart() {
            const saved = localStorage.getItem('okf_cart');
            if (saved) state.cart = JSON.parse(saved);
            updateBadge();
        }

        function saveCart() {
            localStorage.setItem('okf_cart', JSON.stringify(state.cart));
            updateBadge();
            renderCartItems();
            renderProducts(); // Re-render grid to update counts
        }

        function updateBadge() {
            const count = state.cart.reduce((a, b) => a + b.count, 0);
            const badge = document.getElementById('cart-badge');
            badge.innerText = count;
            badge.classList.toggle('hidden', count === 0);

            const total = state.cart.reduce((a, b) => a + (b.price * b.count), 0);
            document.getElementById('cart-total').innerText = total.toLocaleString() + ' UZS';
            document.getElementById('checkout-btn').disabled = count === 0;
        }

        function openCart() {
            const modal = document.getElementById('cart-modal');
            const content = document.getElementById('cart-content');

            modal.classList.remove('hidden');
            // Small delay to allow display:block to apply before transition
            setTimeout(() => {
                content.classList.remove('translate-y-full', 'md:translate-y-10', 'md:opacity-0');
            }, 10);
            renderCartItems();
        }

        function closeCart() {
            const modal = document.getElementById('cart-modal');
            const content = document.getElementById('cart-content');

            content.classList.add('translate-y-full', 'md:translate-y-10', 'md:opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items');
            if (state.cart.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 py-10">${TR[state.lang].cart_empty}</div>`;
                return;
            }

            container.innerHTML = state.cart.map((item, idx) => `
                <div class="flex items-center gap-4 bg-gray-50 p-3 rounded-xl">
                    <img src="${item.image || 'https://via.placeholder.com/50'}" class="w-16 h-16 object-contain bg-white rounded-lg p-1">
                    <div class="flex-1">
                        <div class="text-sm font-medium leading-tight mb-1">${escapeHtml(item.name)}</div>
                        <div class="text-xs text-gray-500">${Number(item.price).toLocaleString()} UZS</div>
                    </div>
                    <div class="flex items-center gap-3 bg-white px-2 py-1 rounded-lg border border-gray-100 shadow-sm">
                        <button onclick="updateCount(${idx}, -1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-black font-bold">-</button>
                        <span class="text-sm font-medium w-4 text-center">${item.count}</span>
                        <button onclick="updateCount(${idx}, 1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-black font-bold">+</button>
                    </div>
                </div>
            `).join('');
        }

        function updateCount(idx, delta) {
            state.cart[idx].count += delta;
            if (state.cart[idx].count <= 0) {
                state.cart.splice(idx, 1);
            }
            saveCart();
        }

        function updateProductCount(id, delta) {
            const itemIdx = state.cart.findIndex(i => i.id === id);

            if (itemIdx > -1) {
                state.cart[itemIdx].count += delta;
                if (state.cart[itemIdx].count <= 0) {
                    state.cart.splice(itemIdx, 1);
                }
            } else if (delta > 0) {
                const product = state.products.find(p => p.id === id);
                if (product) {
                    state.cart.push({ ...product, count: 1 });
                    showToast(TR[state.lang].added + product.name);
                }
            }
            saveCart();
        }

        // --- CHECKOUT ---
        function openCheckout() {
            const total = state.cart.reduce((a, b) => a + (b.price * b.count), 0);
            if (total < 300000) {
                showToast(TR[state.lang].min_order_error);
                return;
            }
            closeCart();
            document.getElementById('checkout-modal').classList.remove('hidden');
        }

        function closeCheckout() {
            document.getElementById('checkout-modal').classList.add('hidden');
        }

        async function submitOrder() {
            const btn = document.getElementById('submit-btn');
            const data = {
                name: document.getElementById('order-name').value,
                phone: document.getElementById('order-phone').value,
                district: document.getElementById('order-district').value,
                address: document.getElementById('order-address').value,
                cart: state.cart,
                total: state.cart.reduce((a, b) => a + (b.price * b.count), 0)
            };

            if (!data.name || !data.phone || !data.district || !data.address) {
                showToast('Заполните все поля!');
                return;
            }

            btn.disabled = true;
            btn.innerText = 'Sending...';

            if (MOCK_MODE) {
                setTimeout(() => {
                    showToast(TR[state.lang].success);
                    state.cart = [];
                    saveCart();
                    closeCheckout();
                    btn.disabled = false;
                    btn.innerText = TR[state.lang].submit_btn;
                }, 1000);
            } else {
                try {
                    const res = await fetch(GAS_APP_URL, {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    const resData = await res.json();
                    if (resData.status === 'success') {
                        showToast(TR[state.lang].success);
                        state.cart = [];
                        saveCart();
                        closeCheckout();
                    } else {
                        showToast(TR[state.lang].error + ' ' + resData.message);
                    }
                } catch (e) {
                    showToast(TR[state.lang].error);
                    console.error(e);
                } finally {
                    btn.disabled = false;
                    btn.innerText = TR[state.lang].submit_btn;
                }
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('opacity-0', 'translate-y-4');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4');
            }, 3000);
        }

        // --- LIGHTBOX ---
        function openImage(src) {
            if (!src) return;
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = src;
            lightbox.classList.remove('hidden');
        }

        function closeImage() {
            const lightbox = document.getElementById('lightbox');
            lightbox.classList.add('hidden');
        }
    </script>
</body>

</html>
